<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="google-site-verification" content="I-tP-pxN_zm4opKxF0P8T1R4yQMAPQ7OLMamNToLgTw">
    

    <title>
      Java I/O 23 - ObjectInputStream | Mr.Muzi 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Nathan R. Lee">
    
    

    <meta name="description" content="&amp;emsp;&amp;emsp;关于 java.io.ObjectInputStream 的部分笔记，ObjectInputStream是Java反序列化操作的实现类，通过该类可以完成默认的或者自定义的对象反序列化操作。本文演示代码段的执行环境基于JDK版本1.7。">
<meta name="keywords" content="ObjectInputStream,反序列化">
<meta property="og:type" content="article">
<meta property="og:title" content="Java I&#x2F;O 23 - ObjectInputStream | Mr.Muzi">
<meta property="og:url" content="https://marcuseddie.github.io/2018/java-ObjectInputStream.html">
<meta property="og:site_name" content="Mr.Muzi">
<meta property="og:description" content="&amp;emsp;&amp;emsp;关于 java.io.ObjectInputStream 的部分笔记，ObjectInputStream是Java反序列化操作的实现类，通过该类可以完成默认的或者自定义的对象反序列化操作。本文演示代码段的执行环境基于JDK版本1.7。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2023-11-03T09:11:26.357Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java I&#x2F;O 23 - ObjectInputStream | Mr.Muzi">
<meta name="twitter:description" content="&amp;emsp;&amp;emsp;关于 java.io.ObjectInputStream 的部分笔记，ObjectInputStream是Java反序列化操作的实现类，通过该类可以完成默认的或者自定义的对象反序列化操作。本文演示代码段的执行环境基于JDK版本1.7。">
    
    
    
      <link rel="icon" type="image/x-icon" href="/images/icon_log1.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/hint.min.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">
    <link rel="stylesheet" href="/css/font-awesome.css">
    <link rel="stylesheet" href="/css/suspend.css">
    <link rel="stylesheet" href="/css/popup.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    <div class="suspend">
      <div class="site-search">
        <div class="popup">
          <span class="search-icon fa fa-search"></span>
          <input type="text" id="local-search-input" placeholder="输入关键字">
          <div id="local-search-result"></div>
          <span class="popup-btn-close">close</span>
        </div>
      </div>      
    </div>
    
    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        
        <a href="/" title="link to homepage for Mr.Muzi"><img src="/images/icon_log1.png" width="80" alt="Mr.Muzi logo" class="panel-cover__logo logo"></a>
        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Mr.Muzi</a></h1>
        <hr class="panel-cover__divider">

        
        <p class="panel-cover__description">
          一只很安静的monkey
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/library" title class>图书馆</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title class>归档</a></li>
              
                
                <li class="navigation__item"><a href="/en/#blog" title class>英文</a></li>
              
                
                <li class="navigation__item"><a href="/about" title class>关于</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <li class="navigation__item">
        <a href="https://github.com/MarcusEddie" title="GitHub">
          <i class="icon icon-social-github"></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    

    
      <!-- Github -->
      <li class="navigation__item">
        <a href="javascript:;" class="popup-trigger" title="search">
          <i class="icon icon-page-search"></i>
          <span class="label">Search</span>
        </a>
      </li>
    

    <!-- China social icon -->
    <!--
    
      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-douban'></i>
          <span class="label">Douban</span>
        </a>
      </li>

      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-weibo'></i>
          <span class="label">Weibo</span>
        </a>
      </li>

    -->



  </ul>
</nav>



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">
  	<header class="post-header">
	    <h1 class="post-title"><b>Java I/O 23 - ObjectInputStream</b></h1>
	    
		    <div class="post-meta">
		      	<time datetime="2018-11-28" class="post-meta__date date">2018-11-28</time> 
		        <span class="post-meta__count count">字数统计:&nbsp;9.5k&emsp;阅读时长:&nbsp;43&nbsp;mins</span>
		      	<span class="post-meta__tags tags">
			        
			            <font class="categories">
				            &#8226; 分类:
				            <a class="categories-link" href="/categories/源码阅读/">源码阅读</a>
			            </font>
			        

			        
			            &#8226; 标签:
			            <font class="tags">
			              	<a class="tags-link" href="/tags/JDK-1-7/">JDK 1.7</a>, <a class="tags-link" href="/tags/Java-IO/">Java IO</a>
			            </font>
			        
		    	</span>
		    </div>
	    
  	</header>

  	<section id="post-content" class="article-content post">
  		

    	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>&emsp;&emsp;关于<em> <strong>java.io.ObjectInputStream</strong> </em>的部分笔记，ObjectInputStream是Java反序列化操作的实现类，通过该类可以完成默认的或者自定义的对象反序列化操作。本文演示代码段的执行环境基于JDK版本<strong>1.7</strong>。</p>
<a id="more"></a>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>&emsp;&emsp;ObjectInputStream对来自于ObjectOutputStream的基础数据类型和对象数据做反序列化操作。ObjectInputStream和ObjectOutputStream被用于持久化存储对象数据（只有支持<strong>java.io.Serializable</strong>和<strong>java.io.Externalizable</strong>的对象才会拥有这个能力）的场景中。<strong>java.io.Serializable</strong>和<strong>java.io.Externalizable</strong>这两个接口决定了序列化和反序列化的执行过程。用来将数据序列化处理之后通过网络等途径传输到目标持久化位置，而ObjectInputStream则会将序列化之后的数据反序列之后传入内存中供计算机程序处理，保证了从流中得到的对象还原成JVM支持的数据类型。</p>
<p>&emsp;&emsp;ObjectInputStream中的<strong>readObject()</strong>方法会从流中读取被序列化的对象数据。基础数据类型可以通过readXX()方法得到。默认的反序列化机制会计算并返回对象的每个字段被序列化之前的类型和存储的内容。如果字段声明中含有<strong>transient</strong>或者<strong>static</strong>，那么这些字段在反序列化的过程中不会被恢复。如果在一个对象中引用了其他对象，那么这些被引用的对象也会被序列化且ObjectInputStream会从流中尝试反序列这些对象。在反序列化的过程中，新的对象和原有对象分别占用不同的内存空间，所以对原有对象的修改不会影响到新对象，反之亦然。</p>
<p>&emsp;&emsp;前面说过共有两个接口来标识可序列化的类：java.io.Serializable和java.io.Externalizable。实现了java.io.Serializable接口的对象可以被对象序列化机制自动地存储和恢复类的所有内容和状态，并且允许类在对象被写入流和从流中读取的时间段内发生变化。如果说某个实现了java.io.Serializable接口的类需要自定义序列化和反序列操作，那么就需要实现<strong>readObjectNoData()</strong>、<strong>writeObject(java.io.ObjectOutputStream stream)</strong>、<strong>readObject(java.io.ObjectInputStream stream)</strong>方法。readObject方法负责从流中读取数据并且恢复类的各个状态，恢复的基础是依据通过对应的writeObject方法向流中写入的对象已经被序列化了的数据内容。被反序列之后的新对象通过从ObjectInputStream中读取数据并且完成对象中各个字段的赋值操作。如果在读书序列化数据执行反序列操作时数据读取越界，那么就会抛出一个<strong>OptionalDataException</strong>异常。</p>
<p>&emsp;&emsp;序列化操作不会对没有实现Serializable接口的对象进行操作，如果父类没有序列化，那么其子类依旧可以做序列化操作，这种情况下子类需要对没有不支持序列化的父类的保存和还原负责，这时需要父类的字段属性的权限类型是public, package, 或者protected，以及提供用来还原字段内容的get/set方法。</p>
<p>&emsp;</p>
<h2 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectInputStream</span></span><br><span class="line">--java.lang.Object</span><br><span class="line">  --java.io.InputStream</span><br><span class="line">    --java.io.ObjectInputStream</span><br></pre></td></tr></table></figure>
<p>&emsp;</p>
<h2 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h2><div class="table-container">
<table>
<thead>
<tr>
<th>类名</th>
<th>实现接口</th>
</tr>
</thead>
<tbody>
<tr>
<td>ObjectInputStream</td>
<td>Closeable, DataInput, ObjectInput, ObjectStreamConstants, AutoCloseable</td>
</tr>
</tbody>
</table>
</div>
<p>&emsp;</p>
<h2 id="ObjectInputStream"><a href="#ObjectInputStream" class="headerlink" title="ObjectInputStream"></a>ObjectInputStream</h2><h3 id="Constructor-Summary"><a href="#Constructor-Summary" class="headerlink" title="Constructor Summary"></a>Constructor Summary</h3><h4 id="public-ObjectInputStream-InputStream-in"><a href="#public-ObjectInputStream-InputStream-in" class="headerlink" title="public ObjectInputStream(InputStream in)"></a>public ObjectInputStream(InputStream in)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ObjectInputStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    verifySubclass();</span><br><span class="line">    bin = <span class="keyword">new</span> BlockDataInputStream(in);</span><br><span class="line">    handles = <span class="keyword">new</span> HandleTable(<span class="number">10</span>);</span><br><span class="line">    vlist = <span class="keyword">new</span> ValidationList();</span><br><span class="line">    enableOverride = <span class="keyword">false</span>;</span><br><span class="line">    readStreamHeader();</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;根据指定输入流初始化一个ObjectInputStream实例。在过程中会从流中读取一个序列化流头部信息，如果序列化尚未将流头部信息写入到流中那么该过程会阻塞。之后会执行security manager。</p>
<p>如果有子类继承了当前ObjectInputStream，那么<strong>verifySubclass()</strong>方法需要检查子类是否违反安全限制：子类不能覆盖安全敏感的非final方法，否则将执行“支持子类实现”的序列化准许（”enableSubclassImplementation” SerializablePermission）检查。</p>
<p>&emsp;&emsp;之后初始化一个BlockDataInputStream完成数据读取。调用<strong>readStreamHeader()</strong>完成流头部信息读取操作。如果流头部信息不正确，抛出<strong>StreamCorruptedException</strong>异常，如果在读取流头部过程中发生I/O异常，那么抛出<strong>IOException</strong>。</p>
<h4 id="protected-ObjectInputStream"><a href="#protected-ObjectInputStream" class="headerlink" title="protected ObjectInputStream()"></a>protected ObjectInputStream()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ObjectInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException, SecurityException </span>&#123;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sm.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class="line">    &#125;</span><br><span class="line">    bin = <span class="keyword">null</span>;</span><br><span class="line">    handles = <span class="keyword">null</span>;</span><br><span class="line">    vlist = <span class="keyword">null</span>;</span><br><span class="line">    enableOverride = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;为子类提供了一种可以完全重新实现ObjectInputStream的途径，这个方法不需要再单独分配私有字段而直接使用ObjectInputStream中的字段。如果存在security manager，那么首先需要调用<strong>checkPermission(Permission perm)</strong>完成检查，保证“支持子类实现”的序列化准许（”enableSubclassImplementation” SerializablePermission）检查适用于子类。</p>
<h3 id="部分方法"><a href="#部分方法" class="headerlink" title="部分方法"></a>部分方法</h3><h4 id="private-void-verifySubclass"><a href="#private-void-verifySubclass" class="headerlink" title="private void verifySubclass()"></a>private void verifySubclass()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifySubclass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class cl = getClass();</span><br><span class="line">    <span class="keyword">if</span> (cl == ObjectInputStream.class) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    processQueue(Caches.subclassAuditsQueue, Caches.subclassAudits);</span><br><span class="line">    WeakClassKey key = <span class="keyword">new</span> WeakClassKey(cl, Caches.subclassAuditsQueue);</span><br><span class="line">    Boolean result = Caches.subclassAudits.get(key);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = Boolean.valueOf(auditSubclass(cl));</span><br><span class="line">        Caches.subclassAudits.putIfAbsent(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result.booleanValue()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sm.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;检查子类是否违反安全限制：子类不能覆盖安全敏感的非final方法，否则将执行“支持子类实现”的序列化准许（”enableSubclassImplementation” SerializablePermission）检查。或者说，该方法会检查当前需要构造的类是不是ObjectInputStream自身或者其子类。</p>
<p>&emsp;&emsp;第2 ~ 5行代码获取当前运行的类，如果是ObjectInputStream自身，那么直接返回。第6 ~ 9行代码判断是否带有SecurityManager，如果没有直接返回。第10行代码通过如下方法移除Caches中已经失去引用的class对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">processQueue(ReferenceQueue&lt;Class&lt;?&gt;&gt; queue,</span><br><span class="line">                             ConcurrentMap&lt;? extends WeakReference&lt;Class&lt;?&gt;&gt;, ?&gt; map)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;第11行代码通过初始化一个弱引用将ObjectInputStream的子类存入Caches中。在第14行代码中检查当前子类是否覆盖了安全敏感的非final方法，如果是安全的（检查通过了），那么返回true，否则返回false标识检查未通过。然后在15行代码中将当前ObjectInputStream子类维护到Caches的subclassAudits集合中。</p>
<p>&emsp;&emsp;最后第20行代码完成当前实现类是否拥有SUBCLASS_IMPLEMENTATION_PERMISSION权限，如果没有，则需要抛出SecurityException异常。 </p>
<h4 id="private-static-boolean-auditSubclass-final-Class-lt-gt-subcl"><a href="#private-static-boolean-auditSubclass-final-Class-lt-gt-subcl" class="headerlink" title="private static boolean auditSubclass(final Class&lt;?&gt; subcl)"></a>private static boolean auditSubclass(final Class&lt;?&gt; subcl)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">auditSubclass</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; subcl)</span> </span>&#123;</span><br><span class="line">    Boolean result = AccessController.doPrivileged(</span><br><span class="line">        <span class="keyword">new</span> PrivilegedAction&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (Class&lt;?&gt; cl = subcl;</span><br><span class="line">                     cl != ObjectInputStream.class;</span><br><span class="line">                     cl = cl.getSuperclass())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cl.getDeclaredMethod(</span><br><span class="line">                            <span class="string">"readUnshared"</span>, (Class[]) <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cl.getDeclaredMethod(<span class="string">"readFields"</span>, (Class[]) <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> result.booleanValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;用来完成子类的安全检查。检查子类是否覆盖了安全敏感的非final方法，如果没有返回true表示检查通过，否则返回false。</p>
<p>&emsp;&emsp;第5 ~ 8行代码从入参subc1自身开始，依次得到其直接父类，直到到达ObjectInputStream，检查每个类是否存在”readUnshared”和”readFields”方法，如果有，返回false，否则抛出<strong>NoSuchMethodException</strong>异常最后返回true表示检查通过。</p>
<h4 id="protected-void-readStreamHeader"><a href="#protected-void-readStreamHeader" class="headerlink" title="protected void readStreamHeader()"></a>protected void readStreamHeader()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readStreamHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException, StreamCorruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">short</span> s0 = bin.readShort();</span><br><span class="line">    <span class="keyword">short</span> s1 = bin.readShort();</span><br><span class="line">    <span class="keyword">if</span> (s0 != STREAM_MAGIC || s1 != STREAM_VERSION) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">            String.format(<span class="string">"invalid stream header: %04X%04X"</span>, s0, s1));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;协助子类读取和验证它们自己的流头部，过程中会读取和校验魔数和版本号。这两个数都是序列化过程中写入到流里的。</p>
<h4 id="public-final-Object-readObject"><a href="#public-final-Object-readObject" class="headerlink" title="public final Object readObject()"></a>public final Object readObject()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (enableOverride) &#123;</span><br><span class="line">        <span class="keyword">return</span> readObjectOverride();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if nested read, passHandle contains handle of enclosing object</span></span><br><span class="line">    <span class="keyword">int</span> outerHandle = passHandle;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object obj = readObject0(<span class="keyword">false</span>);</span><br><span class="line">        handles.markDependency(outerHandle, passHandle);</span><br><span class="line">        ClassNotFoundException ex = handles.lookupException(passHandle);</span><br><span class="line">        <span class="keyword">if</span> (ex != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">            vlist.doCallbacks();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        passHandle = outerHandle;</span><br><span class="line">        <span class="keyword">if</span> (closed &amp;&amp; depth == <span class="number">0</span>) &#123;</span><br><span class="line">            clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从ObjectInputStream中读取一个对象，final关键字表示该方法不可能被子类覆盖。对象的类型、类型签名、未被transient和static修饰的字段值以及该对象的所有父类型都会被读取到。对一个类对象的默认的反序列操作可通过readObject()和writeObject()方法覆盖以实现个性化需求。与该对象相关的所有对象都会被readObject()方法读取到以保证可以完整的完成反序列化。需要注意的是，只有当当前对象的所有字段以及其所有引用的其他对象都被恢复了以后，这个对象的反序列化过程才算完成。</p>
<p>&emsp;&emsp;第2 ~ 4行代码如果需要使用子类实现来完成数据读取，那么就调用readObjectOverride()。enableOverride字段会在<strong>protected ObjectInputStream()</strong>构造器中被指定为true，而该构造器是给ObjectInputStream的子类初始化用的，所以如果是子类实现，那么就用子类的读取方法来完成数据读取操作。如果类里面定义了非基本数据类型变量，需要进行嵌套读取，outerHandle用来存储上一层读取对象的句柄，所以第7行代码维护了上一层读取对象的句柄。然后调用<strong>readObject0</strong>读取生成对象（<strong>整个方法的核心！核心！核心！</strong>）。完成之后要记录句柄依赖（第10行代码），并检查有无异常产生（第11行代码）。第15 ~ 17行代码表示最上层读取完成之后要发起回调，最后返回反序列的对象obj。</p>
<p>&emsp;&emsp;第20 ~ 24行代码如果最上层调用结束后那么清空相关记录缓存（包含但不限于调用返回列表和句柄缓存）。</p>
<h4 id="protected-Object-readObjectOverride"><a href="#protected-Object-readObjectOverride" class="headerlink" title="protected Object readObjectOverride()"></a>protected Object readObjectOverride()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">readObjectOverride</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;ObjectInputStream的子类覆盖该方法以完成子类的反序列的操作。留给子类用的，ObjectInputStream自身无法使用该方法。</p>
<h4 id="private-Object-readObject0-boolean-unshared"><a href="#private-Object-readObject0-boolean-unshared" class="headerlink" title="private Object readObject0(boolean unshared)"></a>private Object readObject0(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readObject0</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> oldMode = bin.getBlockDataMode();</span><br><span class="line">    <span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">        <span class="keyword">int</span> remain = bin.currentBlockRemaining();</span><br><span class="line">        <span class="keyword">if</span> (remain &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(remain);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultDataEnd) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Fix for 4360508: stream is currently at the end of a field</span></span><br><span class="line"><span class="comment">             * value block written via default serialization; since there</span></span><br><span class="line"><span class="comment">             * is no terminating TC_ENDBLOCKDATA tag, simulate</span></span><br><span class="line"><span class="comment">             * end-of-custom-data behavior explicitly.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span> tc;</span><br><span class="line">    <span class="keyword">while</span> ((tc = bin.peekByte()) == TC_RESET) &#123;</span><br><span class="line">        bin.readByte();</span><br><span class="line">        handleReset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    depth++;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">            <span class="keyword">case</span> TC_NULL:</span><br><span class="line">                <span class="keyword">return</span> readNull();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_REFERENCE:</span><br><span class="line">                <span class="keyword">return</span> readHandle(unshared);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_CLASS:</span><br><span class="line">                <span class="keyword">return</span> readClass(unshared);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_CLASSDESC:</span><br><span class="line">            <span class="keyword">case</span> TC_PROXYCLASSDESC:</span><br><span class="line">                <span class="keyword">return</span> readClassDesc(unshared);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_STRING:</span><br><span class="line">            <span class="keyword">case</span> TC_LONGSTRING:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readString(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ARRAY:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readArray(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ENUM:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readEnum(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_OBJECT:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readOrdinaryObject(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_EXCEPTION:</span><br><span class="line">                IOException ex = readFatalException();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WriteAbortedException(<span class="string">"writing aborted"</span>, ex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_BLOCKDATA:</span><br><span class="line">            <span class="keyword">case</span> TC_BLOCKDATALONG:</span><br><span class="line">                <span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">                    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">                    bin.peek();             <span class="comment">// force header read</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(</span><br><span class="line">                        bin.currentBlockRemaining());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                        <span class="string">"unexpected block data"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ENDBLOCKDATA:</span><br><span class="line">                <span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                        <span class="string">"unexpected end of block data"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                    String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        depth--;</span><br><span class="line">        bin.setBlockDataMode(oldMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;readObject0必须在上一次反序列化操作彻底完成后（此时流内不存在任何数据）才能开始当前的读取和反序列化操作，否则会抛出异常。</p>
<p>&emsp;&emsp;第2 ~ 17行代码用来判断当前操作开始前流内是否存在上次反序列操作未处理的剩余数据，如果有，那么就抛出<strong>OptionalDataException</strong>异常。判断操作都执行完后执行<strong>bin.setBlockDataMode(false)</strong>标记本次读取和反序列操作开始。</p>
<p>&emsp;&emsp;第19 ~ 23行代码中，如果读取的下一个字节是“TC_RESET”，那么意味着所有写入到流中的数据都会被重置。所以读取一个字节内容，然后调用<strong>handleReset()</strong>完成重置操作。</p>
<p>&emsp;&emsp;第25行代码表示每调用一次readObject0方法，嵌套深度加一。</p>
<p>&emsp;&emsp;之后根据读取到的tc码来分场景反序列恢复数据内容：</p>
<ol>
<li>第28 ~ 30行代码表示如果恢复的是一个null元素引用，那么调用<strong>readNull()</strong>完成处理。</li>
<li>第31 ~ 33行代码表示如果恢复的是一个指向已经写入到流里的对象的引用，那么调用<strong>readHandle(boolean unshared)</strong>读取引用对象完成处理。</li>
<li>第34 ~ 36行代码表示如果恢复的是一个指向类的引用，那么调用<strong>readClass(boolean unshared)</strong>读取一个类完成处理。</li>
<li>第37 ~ 40行代码表示如果恢复的是一个指向类描述符或者代理类描述符的引用，那么调用<strong>readClassDesc(boolean unshared)</strong>读取一个类描述符完成处理。</li>
<li>第41 ~ 44行代码表示如果恢复的是一个String 或者long String（Unicode&gt;0xFF），那么调用<strong>checkResolve(Object obj)</strong>检查<strong>readString(boolean unshared)</strong>的返回内容。</li>
<li>第45 ~ 47行代码表示如果恢复的是一个数组，那么调用<strong>checkResolve(Object obj)</strong>检查<strong>readArray(boolean unshared)</strong>的返回内容。</li>
<li>第48 ~ 50行代码表示如果恢复的是一个枚举常量，那么调用<strong>checkResolve(Object obj)</strong>检查<strong>readEnum(boolean unshared)</strong>的返回内容。</li>
<li>第51 ~ 53行代码表示如果恢复的是一个Object，那么调用<strong>checkResolve(Object obj)</strong>检查<strong>readOrdinaryObject(boolean unshared)</strong>的返回内容。</li>
<li>第54 ~ 57行代码表示如果恢复的是一个写入过程中产生的异常，那么调用<strong>readFatalException()</strong>获取异常内容。</li>
<li>第58 ~ 69行代码表示如果恢复的是一个块数据，那么抛出异常内容。</li>
<li>第70 ~ 77行代码表示如果恢复的是一个块数据结束标志，那么抛出异常内容。</li>
</ol>
<p>&emsp;&emsp;如果都不符合上述十一个场景，那么抛出异常。最后将深度减一表示当前层次处理已经完成。</p>
<h4 id="private-void-handleReset"><a href="#private-void-handleReset" class="headerlink" title="private void handleReset()"></a>private void handleReset()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleReset</span><span class="params">()</span> <span class="keyword">throws</span> StreamCorruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (depth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">            <span class="string">"unexpected reset; recursion depth: "</span> + depth);</span><br><span class="line">    &#125;</span><br><span class="line">    clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;如果发生了嵌套读取反序列操作，且当前操作不处于最顶层，那么抛出<strong>StreamCorruptedException</strong>异常。如果处于最顶层，则调用<strong>clear()</strong>方法完成内部数据结构的清空操作。</p>
<h4 id="private-void-clear"><a href="#private-void-clear" class="headerlink" title="private void clear()"></a>private void clear()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    handles.clear();</span><br><span class="line">    vlist.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;清空并使得句柄HandleTable处于初始态。清空并使得回调列表ValidationList处于初始态。</p>
<h4 id="private-Object-readNull"><a href="#private-Object-readNull" class="headerlink" title="private Object readNull()"></a>private Object readNull()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readNull</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_NULL) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line">    passHandle = NULL_HANDLE;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这个方法处理的读取到的元素是null的场景，如果实际读到的不是null，那么抛出异常。反之，由于passHandle维护的是一个对象句柄，而此方法读取并返回的是一个null，所以句柄被置为null并返回null。</p>
<h4 id="private-Object-readHandle-boolean-unshared"><a href="#private-Object-readHandle-boolean-unshared" class="headerlink" title="private Object readHandle(boolean unshared)"></a>private Object readHandle(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readHandle</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_REFERENCE) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line">    passHandle = bin.readInt() - baseWireHandle;</span><br><span class="line">    <span class="keyword">if</span> (passHandle &lt; <span class="number">0</span> || passHandle &gt;= handles.size()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">            String.format(<span class="string">"invalid handle value: %08X"</span>, passHandle +</span><br><span class="line">                          baseWireHandle));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (unshared) &#123;</span><br><span class="line">        <span class="comment">// REMIND: what type of exception to throw here?</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(</span><br><span class="line">            <span class="string">"cannot read back reference as unshared"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object obj = handles.lookupObject(passHandle);</span><br><span class="line">    <span class="keyword">if</span> (obj == unsharedMarker) &#123;</span><br><span class="line">        <span class="comment">// REMIND: what type of exception to throw here?</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(</span><br><span class="line">            <span class="string">"cannot read back reference to unshared object"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从流里读取到一个对象句柄，将passHandle置为读取到的这个句柄，并返回一个关联到该句柄上的对象。如果当前读到的不是一个REFERENCE标识，那么抛出异常。因为在向流写入的过程中数据等于handle值加baseWireHandle的和，所以这里要减去还原。由于元素handle值在写入时是逐个增加的（实际上在写入过程中是依据写入环境的handle集合存储的元素个数作为handle存储的index下标的，最终实现效果就是在尾部加入元素）所以passHandle值不可能大于handles的长度，如果不满条件，那么抛出异常。</p>
<p>&emsp;&emsp;如果unshared为true，抛出异常。从缓存中寻找并取出对象。如果找到的对象带有unshared标记，抛出异常。反之向方法调用方返回找到的对象。</p>
<h4 id="private-Class-readClass-boolean-unshared"><a href="#private-Class-readClass-boolean-unshared" class="headerlink" title="private Class readClass(boolean unshared)"></a>private Class readClass(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Class <span class="title">readClass</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_CLASS) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line">    ObjectStreamClass desc = readClassDesc(<span class="keyword">false</span>);</span><br><span class="line">    Class cl = desc.forClass();</span><br><span class="line">    passHandle = handles.assign(unshared ? unsharedMarker : cl);</span><br><span class="line"></span><br><span class="line">    ClassNotFoundException resolveEx = desc.getResolveException();</span><br><span class="line">    <span class="keyword">if</span> (resolveEx != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handles.markException(passHandle, resolveEx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handles.finish(passHandle);</span><br><span class="line">    <span class="keyword">return</span> cl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从流里读取并返回一个类对象，将passHandle置为类对象分配的句柄。如果类无法被解析（ClassNotFoundException会被关联到类的句柄上），那么返回null。</p>
<p>&emsp;&emsp;如果当前读到的不是一个TC_CLASS标识，那么抛出异常。紧接着读取并返回一个类描述符。如果得到的类描述符无法正常解析出一个可以在本地VM运行的类，那么抛出异常。从返回的类描述符中返回一个来自于本地VM的类。然后根据unshared标记决定passHandle是指向一个unsharedMarker还是刚才得到的类。</p>
<p>&emsp;&emsp;第9行代码检查在解析本地类的过程中是否出现了异常，如果有异常，需要将当前passHandle与异常建立映射关系。结束当前passHandle的映射建立过程，该passHandle将不会与其他新的对象建立映射关系。最后返回得到的类。</p>
<h4 id="private-ObjectStreamClass-readClassDesc-boolean-unshared"><a href="#private-ObjectStreamClass-readClassDesc-boolean-unshared" class="headerlink" title="private ObjectStreamClass readClassDesc(boolean unshared)"></a>private ObjectStreamClass readClassDesc(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ObjectStreamClass <span class="title">readClassDesc</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span> tc = bin.peekByte();</span><br><span class="line">    <span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">        <span class="keyword">case</span> TC_NULL:</span><br><span class="line">            <span class="keyword">return</span> (ObjectStreamClass) readNull();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TC_REFERENCE:</span><br><span class="line">            <span class="keyword">return</span> (ObjectStreamClass) readHandle(unshared);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TC_PROXYCLASSDESC:</span><br><span class="line">            <span class="keyword">return</span> readProxyDesc(unshared);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TC_CLASSDESC:</span><br><span class="line">            <span class="keyword">return</span> readNonProxyDesc(unshared);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回一个类描述符。将passHandle分给类描述符指定的句柄。如果类描述符无法正确解析成一个本地VM中的一个类，那么抛出<strong>ClassNotFoundException</strong>异常。</p>
<p>&emsp;&emsp;读取TC标识，如果TC标识为TC_NULL，那么调用readNull()返回一个null对象。</p>
<p>&emsp;&emsp;如果TC标识为TC_REFERENCE，那么调用readHandle(boolean unshared)返回一个句柄指向的对象。</p>
<p>&emsp;&emsp;如果TC标识为TC_PROXYCLASSDESC，那么调用readProxyDesc(boolean unshared)返回一个动态代理类的类描述符。</p>
<p>&emsp;&emsp;如果TC标识为TC_CLASSDESC，那么调用readNonProxyDesc(boolean unshared)返回一个非动态代理类的类描述符。</p>
<p>&emsp;&emsp;如果不是上述场景，抛出异常。</p>
<h4 id="private-ObjectStreamClass-readProxyDesc-boolean-unshared"><a href="#private-ObjectStreamClass-readProxyDesc-boolean-unshared" class="headerlink" title="private ObjectStreamClass readProxyDesc(boolean unshared)"></a>private ObjectStreamClass readProxyDesc(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ObjectStreamClass <span class="title">readProxyDesc</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_PROXYCLASSDESC) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ObjectStreamClass desc = <span class="keyword">new</span> ObjectStreamClass();</span><br><span class="line">    <span class="keyword">int</span> descHandle = handles.assign(unshared ? unsharedMarker : desc);</span><br><span class="line">    passHandle = NULL_HANDLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numIfaces = bin.readInt();</span><br><span class="line">    String[] ifaces = <span class="keyword">new</span> String[numIfaces];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numIfaces; i++) &#123;</span><br><span class="line">        ifaces[i] = bin.readUTF();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class cl = <span class="keyword">null</span>;</span><br><span class="line">    ClassNotFoundException resolveEx = <span class="keyword">null</span>;</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((cl = resolveProxyClass(ifaces)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolveEx = <span class="keyword">new</span> ClassNotFoundException(<span class="string">"null class"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Proxy.isProxyClass(cl)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"Not a proxy"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ReflectUtil.checkProxyPackageAccess makes a test</span></span><br><span class="line">            <span class="comment">// equivalent to isCustomSubclass so there's no need</span></span><br><span class="line">            <span class="comment">// to condition this call to isCustomSubclass == true here.</span></span><br><span class="line">            ReflectUtil.checkProxyPackageAccess(getClass().getClassLoader(),</span><br><span class="line">                                                cl.getInterfaces());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        resolveEx = ex;</span><br><span class="line">    &#125;</span><br><span class="line">    skipCustomData();</span><br><span class="line"></span><br><span class="line">    desc.initProxy(cl, resolveEx, readClassDesc(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">    handles.finish(descHandle);</span><br><span class="line">    passHandle = descHandle;</span><br><span class="line">    <span class="keyword">return</span> desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回一个动态代理类的类描述符。如果当前读到的不是一个TC_PROXYCLASSDESC标识，那么抛出异常。第6行代码用来初始化一个空的类描述符，该描述符包含有类描述符的名字和serialVersionUID。第10 ~ 15行代码获取动态代理类实现的接口内容。第20 ~ 21行代码试图返回一个实现了相关接口的动态代理类，如果返回失败，那么抛出异常。如果返回的不是动态代理类，那么抛出异常。紧接着利用类描述符初始化一个动态代理类，更新passHandle的值并返回初始化的动态代理类。</p>
<h4 id="protected-Class-lt-gt-resolveProxyClass-String-interfaces"><a href="#protected-Class-lt-gt-resolveProxyClass-String-interfaces" class="headerlink" title="protected Class&lt;?&gt; resolveProxyClass(String[] interfaces)"></a>protected Class&lt;?&gt; resolveProxyClass(String[] interfaces)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces)</span><br><span class="line">			<span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ClassLoader latestLoader = latestUserDefinedLoader();</span><br><span class="line">    ClassLoader nonPublicLoader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> hasNonPublicInterface = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// define proxy in class loader of non-public interface(s), if any</span></span><br><span class="line">    Class[] classObjs = <span class="keyword">new</span> Class[interfaces.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</span><br><span class="line">        Class cl = Class.forName(interfaces[i], <span class="keyword">false</span>, latestLoader);</span><br><span class="line">        <span class="keyword">if</span> ((cl.getModifiers() &amp; Modifier.PUBLIC) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasNonPublicInterface) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nonPublicLoader != cl.getClassLoader()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessError(</span><br><span class="line">                        <span class="string">"conflicting non-public interface class loaders"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nonPublicLoader = cl.getClassLoader();</span><br><span class="line">                hasNonPublicInterface = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        classObjs[i] = cl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.getProxyClass(</span><br><span class="line">            hasNonPublicInterface ? nonPublicLoader : latestLoader, classObjs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="keyword">null</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;返回一个实现了代理类描述符中包含的所有接口的代理类。ObjectInputStream的子类可以实现这个方法来满足个性化的数据内容的读取需求，为开发人员提供了一种可供选择的接口和代理类的加载机制。第8 ~ 23行代码遍历每个接口信息，根据接口和得到的类加载器生成对应的实现类。如果生成的类是public修饰的，那么判断是否拥有非公共的类加载器。最后从生成的类对象中得到生成的代理类。</p>
<h4 id="private-static-ClassLoader-latestUserDefinedLoader"><a href="#private-static-ClassLoader-latestUserDefinedLoader" class="headerlink" title="private static ClassLoader latestUserDefinedLoader()"></a>private static ClassLoader latestUserDefinedLoader()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ClassLoader <span class="title">latestUserDefinedLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sun.misc.VM.latestUserDefinedLoader();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;返回第一个非null的类加载器到执行栈。</p>
<h4 id="private-void-skipCustomData"><a href="#private-void-skipCustomData" class="headerlink" title="private void skipCustomData()"></a>private void skipCustomData()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipCustomData</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oldHandle = passHandle;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bin.getBlockDataMode()) &#123;</span><br><span class="line">            bin.skipBlockData();</span><br><span class="line">            bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (bin.peekByte()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TC_BLOCKDATA:</span><br><span class="line">            <span class="keyword">case</span> TC_BLOCKDATALONG:</span><br><span class="line">                bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ENDBLOCKDATA:</span><br><span class="line">                bin.readByte();</span><br><span class="line">                passHandle = oldHandle;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                readObject0(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;跳过所有的块数据和对象直到遇到TC_ENDBLOCKDATA。</p>
<h4 id="private-ObjectStreamClass-readNonProxyDesc-boolean-unshared"><a href="#private-ObjectStreamClass-readNonProxyDesc-boolean-unshared" class="headerlink" title="private ObjectStreamClass readNonProxyDesc(boolean unshared)"></a>private ObjectStreamClass readNonProxyDesc(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ObjectStreamClass <span class="title">readNonProxyDesc</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_CLASSDESC) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ObjectStreamClass desc = <span class="keyword">new</span> ObjectStreamClass();</span><br><span class="line">    <span class="keyword">int</span> descHandle = handles.assign(unshared ? unsharedMarker : desc);</span><br><span class="line">    passHandle = NULL_HANDLE;</span><br><span class="line"></span><br><span class="line">    ObjectStreamClass readDesc = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        readDesc = readClassDescriptor();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(</span><br><span class="line">            <span class="string">"failed to read class descriptor"</span>).initCause(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class cl = <span class="keyword">null</span>;</span><br><span class="line">    ClassNotFoundException resolveEx = <span class="keyword">null</span>;</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> checksRequired = isCustomSubclass();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((cl = resolveClass(readDesc)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolveEx = <span class="keyword">new</span> ClassNotFoundException(<span class="string">"null class"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (checksRequired) &#123;</span><br><span class="line">            ReflectUtil.checkPackageAccess(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        resolveEx = ex;</span><br><span class="line">    &#125;</span><br><span class="line">    skipCustomData();</span><br><span class="line"></span><br><span class="line">    desc.initNonProxy(readDesc, cl, resolveEx, readClassDesc(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">    handles.finish(descHandle);</span><br><span class="line">    passHandle = descHandle;</span><br><span class="line">    <span class="keyword">return</span> desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回一个不是动态代理类的类描述符。如果当前读到的不是一个TC_CLASSDESC标识，那么抛出异常。第6行代码生成一个类描述符实例，里面含有类名和接口名。第10 ~ 16行代码会从序列化流中读取一个类描述符。第21行代码判断当前类是否是ObjectInputStream的子类实现。第22 ~ 30行代码异常检查。第33行代码会初始化一个非动态代理类，最后返回生成的类描述符。</p>
<h4 id="protected-ObjectStreamClass-readClassDescriptor"><a href="#protected-ObjectStreamClass-readClassDescriptor" class="headerlink" title="protected ObjectStreamClass readClassDescriptor()"></a>protected ObjectStreamClass readClassDescriptor()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ObjectStreamClass <span class="title">readClassDescriptor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectStreamClass desc = <span class="keyword">new</span> ObjectStreamClass();</span><br><span class="line">    desc.readNonProxy(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从序列化流中读取一个类描述符。ObjectInputStream的子类可以覆盖这个方法以此实现可以以非标准化格式写入的类描述符。</p>
<h4 id="protected-Class-lt-gt-resolveClass-ObjectStreamClass-desc"><a href="#protected-Class-lt-gt-resolveClass-ObjectStreamClass-desc" class="headerlink" title="protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc)"></a>protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">			<span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    String name = desc.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Class.forName(name, <span class="keyword">false</span>, latestUserDefinedLoader());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        Class&lt;?&gt; cl = primClasses.get(name);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;加载本地的特定类描述符的类。</p>
<h4 id="private-Object-checkResolve-Object-obj"><a href="#private-Object-checkResolve-Object-obj" class="headerlink" title="private Object checkResolve(Object obj)"></a>private Object checkResolve(Object obj)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">checkResolve</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!enableResolve || handles.lookupException(passHandle) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    Object rep = resolveObject(obj);</span><br><span class="line">    <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">        handles.setObject(passHandle, rep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rep;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在必要时执行对象替换。通过<strong>enableResolveObject(boolean enable)</strong>在初始化ObjectInputStream之后调用设置enableResolve的值。resolveObject(Object obj)方法没有对入参做任何处理，直接返回。第6 ~ 8行代码判断被替换后的对象是否和替换前一直，如果不一致，则用替换后的对象和passHandle建立映射关系，最后会直接返回被替换后的对象。</p>
<h4 id="protected-Object-resolveObject-Object-obj"><a href="#protected-Object-resolveObject-Object-obj" class="headerlink" title="protected Object resolveObject(Object obj)"></a>protected Object resolveObject(Object obj)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">resolveObject</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这个方法提供给被ObjectInputStream信任的子类在反序列化过程中完成对象替换。通过方法<strong>enableResolveObject(boolean enable)</strong>可以得到子类是否能被ObjectInputStream信任。这个方法在对象读取后readObject()方法前被调用处理。默认方法的话直接返回不做任何处理。</p>
<h4 id="private-IOException-readFatalException"><a href="#private-IOException-readFatalException" class="headerlink" title="private IOException readFatalException()"></a>private IOException readFatalException()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IOException <span class="title">readFatalException</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_EXCEPTION) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line">    clear();</span><br><span class="line">    <span class="keyword">return</span> (IOException) readObject0(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回导致序列化操作取消的IOException。如果当前读到的不是一个TC_EXCEPTION标识，那么抛出异常。之后执行清空操作，清除所有内部数据结构。最后返回读取到的异常。</p>
<h4 id="private-String-readString-boolean-unshared"><a href="#private-String-readString-boolean-unshared" class="headerlink" title="private String readString(boolean unshared)"></a>private String readString(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">readString</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String str;</span><br><span class="line">    <span class="keyword">byte</span> tc = bin.readByte();</span><br><span class="line">    <span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">        <span class="keyword">case</span> TC_STRING:</span><br><span class="line">            str = bin.readUTF();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TC_LONGSTRING:</span><br><span class="line">            str = bin.readLongUTF();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">    &#125;</span><br><span class="line">    passHandle = handles.assign(unshared ? unsharedMarker : str);</span><br><span class="line">    handles.finish(passHandle);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回一个String。根据读取到的TC标记选择readUTF()或者readLongUTF()方法完成字符串读取。TC_STRING和TC_LONGSTRING由对应的writeString确定，根据字符串Unicode值是否小于等于0xFFFF来决定写入TC_STRING（&lt;= 0xFFFF）还是TC_LONGSTRING（&gt; 0xFFFF）。如果不是上述两种标识，那么就抛出异常。</p>
<p>&emsp;&emsp;然后建立passHandle句柄和读取到的字符串对象的映射关系。最后返回读取到的字符串。</p>
<h4 id="private-Object-readArray-boolean-unshared"><a href="#private-Object-readArray-boolean-unshared" class="headerlink" title="private Object readArray(boolean unshared)"></a>private Object readArray(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readArray</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_ARRAY) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ObjectStreamClass desc = readClassDesc(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">int</span> len = bin.readInt();</span><br><span class="line"></span><br><span class="line">    Object array = <span class="keyword">null</span>;</span><br><span class="line">    Class cl, ccl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((cl = desc.forClass()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ccl = cl.getComponentType();</span><br><span class="line">        array = Array.newInstance(ccl, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> arrayHandle = handles.assign(unshared ? unsharedMarker : array);</span><br><span class="line">    ClassNotFoundException resolveEx = desc.getResolveException();</span><br><span class="line">    <span class="keyword">if</span> (resolveEx != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handles.markException(arrayHandle, resolveEx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ccl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            readObject0(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ccl == Integer.TYPE) &#123;</span><br><span class="line">            bin.readInts((<span class="keyword">int</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Byte.TYPE) &#123;</span><br><span class="line">            bin.readFully((<span class="keyword">byte</span>[]) array, <span class="number">0</span>, len, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Long.TYPE) &#123;</span><br><span class="line">            bin.readLongs((<span class="keyword">long</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Float.TYPE) &#123;</span><br><span class="line">            bin.readFloats((<span class="keyword">float</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Double.TYPE) &#123;</span><br><span class="line">            bin.readDoubles((<span class="keyword">double</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Short.TYPE) &#123;</span><br><span class="line">            bin.readShorts((<span class="keyword">short</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Character.TYPE) &#123;</span><br><span class="line">            bin.readChars((<span class="keyword">char</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ccl == Boolean.TYPE) &#123;</span><br><span class="line">            bin.readBooleans((<span class="keyword">boolean</span>[]) array, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object[] oa = (Object[]) array;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            oa[i] = readObject0(<span class="keyword">false</span>);</span><br><span class="line">            handles.markDependency(arrayHandle, passHandle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handles.finish(arrayHandle);</span><br><span class="line">    passHandle = arrayHandle;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回一个array数组。如果当前读到的不是一个TC_ARRAY标识，那么抛出异常。第6行代码得到数组类的类描述符，并读取数组的长度大小。第9 ~ 14行代码获取到数组的类型信息，以及数组元素的类型信息，通过Array.newInstance(Class&lt;?&gt; componentType, int length)方法初始化一个数组对象。</p>
<p>&emsp;&emsp;第16 ~ 20行代码判断在当前写入和读取过程中是否出现了异常，如果有异常的话需要将passHandle和异常信息建立映射。第22 ~ 25行代码可能由于cl不是一个数组类，所以ccl为空，那么逐个获取长度为len的元素对象集合。如果数组元素类型为基本数据类型，那么就分类型从流中取数据填充到数组array中（即第26 ~ 45行代码）。如果数组元素为对象类型，那么递归调用readObject0()方法完成数组的填充。最后返回读取到的数据数据。</p>
<h4 id="private-Enum-readEnum-boolean-unshared"><a href="#private-Enum-readEnum-boolean-unshared" class="headerlink" title="private Enum readEnum(boolean unshared)"></a>private Enum readEnum(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Enum <span class="title">readEnum</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_ENUM) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ObjectStreamClass desc = readClassDesc(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!desc.isEnum()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"non-enum class: "</span> + desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> enumHandle = handles.assign(unshared ? unsharedMarker : <span class="keyword">null</span>);</span><br><span class="line">    ClassNotFoundException resolveEx = desc.getResolveException();</span><br><span class="line">    <span class="keyword">if</span> (resolveEx != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handles.markException(enumHandle, resolveEx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String name = readString(<span class="keyword">false</span>);</span><br><span class="line">    Enum en = <span class="keyword">null</span>;</span><br><span class="line">    Class cl = desc.forClass();</span><br><span class="line">    <span class="keyword">if</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            en = Enum.valueOf(cl, name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidObjectException(<span class="string">"enum constant "</span></span><br><span class="line">                                                           + name + <span class="string">" does not exist in "</span> + cl).initCause(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!unshared) &#123;</span><br><span class="line">            handles.setObject(enumHandle, en);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handles.finish(enumHandle);</span><br><span class="line">    passHandle = enumHandle;</span><br><span class="line">    <span class="keyword">return</span> en;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回枚举常量。如果当前读到的不是一个TC_ENUM标识，那么抛出异常。通过<strong>readClassDesc(boolean unshared)</strong>方法获取到类描述符，如果类描述符不是枚举类型，那么抛出异常。之后检查在恢复本地类时是否出现了异常，如果有异常需要建立句柄和异常的映射关系。</p>
<p>&emsp;&emsp;通过readString（boolean unshared)读取枚举类型的名字。然后在第22行代码会初始化一个Enum对象，之后更新passHandle的值并返回初始化的枚举对象。</p>
<h4 id="private-Object-readOrdinaryObject-boolean-unshared"><a href="#private-Object-readOrdinaryObject-boolean-unshared" class="headerlink" title="private Object readOrdinaryObject(boolean unshared)"></a>private Object readOrdinaryObject(boolean unshared)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readOrdinaryObject</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_OBJECT) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ObjectStreamClass desc = readClassDesc(<span class="keyword">false</span>);</span><br><span class="line">    desc.checkDeserialize();</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; cl = desc.forClass();</span><br><span class="line">    <span class="keyword">if</span> (cl == String.class || cl == Class.class</span><br><span class="line">        || cl == ObjectStreamClass.class) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"invalid class descriptor"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object obj;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        obj = desc.isInstantiable() ? desc.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(desc.forClass()</span><br><span class="line">                                                      .getName(), <span class="string">"unable to create instance"</span>).initCause(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    passHandle = handles.assign(unshared ? unsharedMarker : obj);</span><br><span class="line">    ClassNotFoundException resolveEx = desc.getResolveException();</span><br><span class="line">    <span class="keyword">if</span> (resolveEx != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handles.markException(passHandle, resolveEx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (desc.isExternalizable()) &#123;</span><br><span class="line">        readExternalData((Externalizable) obj, desc);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        readSerialData(obj, desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handles.finish(passHandle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp; handles.lookupException(passHandle) == <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; desc.hasReadResolveMethod()) &#123;</span><br><span class="line">        Object rep = desc.invokeReadResolve(obj);</span><br><span class="line">        <span class="keyword">if</span> (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">            rep = cloneArray(rep);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">            handles.setObject(passHandle, obj = rep);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取并返回一个自定义普通对象。如果对象类无法解析，返回一个null。如果当前读到的不是一个TC_OBJECT标识，那么抛出异常。调用<strong>readClassDesc(boolean unshared)</strong>方法完成类描述符的读取操作，如果该类被禁止反序列化，那么抛出<strong>InvalidClassException</strong>异常。第9 ~ 14行代码检查对象的类型，对象类型不应该为String，class，ObjectStreamClass等类，如果是的话就抛出异常。</p>
<p>&emsp;&emsp;第15 ~21行代码实例化一个Object对象，如果对象可以实例化，就完成实例化，否则对象被指定为null。第23 ~ 27行代码检查在转换本地类的过程中是否存在异常，如果有异常需要对异常进行记录处理。如果对象继承的接口是<strong>Externalizable</strong>那么就调用<strong>readExternalData(Externalizable obj, ObjectStreamClass desc)</strong>完成操作，否则就调用<strong>readSerialData(Object obj, ObjectStreamClass desc)</strong>完成操作。</p>
<p>&emsp;&emsp;如果当前已经实例化的对象存在替换对象，首先根据实例化的对象得到其对应的替换对象，如果替换对象的类型是数组，那么就执行数组克隆操作。用替换后的对象替换实例化对象并缓存起来。最后返回实例化的对象。</p>
<h4 id="private-static-Object-cloneArray-Object-array"><a href="#private-static-Object-cloneArray-Object-array" class="headerlink" title="private static Object cloneArray(Object array)"></a>private static Object cloneArray(Object array)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">cloneArray</span><span class="params">(Object array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array <span class="keyword">instanceof</span> Object[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Object[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">boolean</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">boolean</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">byte</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">byte</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">char</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">char</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">double</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">double</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">float</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">float</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">int</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">int</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">long</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">long</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">short</span>[]) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">short</span>[]) array).clone();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在使用非共享读取场景中克隆一个数组。</p>
<h4 id="private-void-readExternalData-Externalizable-obj-ObjectStreamClass-desc"><a href="#private-void-readExternalData-Externalizable-obj-ObjectStreamClass-desc" class="headerlink" title="private void readExternalData(Externalizable obj, ObjectStreamClass desc)"></a>private void readExternalData(Externalizable obj, ObjectStreamClass desc)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readExternalData</span><span class="params">(Externalizable obj, ObjectStreamClass desc)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SerialCallbackContext oldContext = curContext;</span><br><span class="line">    curContext = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> blocked = desc.hasBlockExternalData();</span><br><span class="line">        <span class="keyword">if</span> (blocked) &#123;</span><br><span class="line">            bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                obj.readExternal(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * In most cases, the handle table has already propagated</span></span><br><span class="line"><span class="comment">                     * a CNFException to passHandle at this point; this mark</span></span><br><span class="line"><span class="comment">                     * call is included to address cases where the readExternal</span></span><br><span class="line"><span class="comment">                     * method has cons'ed and thrown a new CNFException of its</span></span><br><span class="line"><span class="comment">                     * own.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                handles.markException(passHandle, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (blocked) &#123;</span><br><span class="line">            skipCustomData();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        curContext = oldContext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * At this point, if the externalizable data was not written in</span></span><br><span class="line"><span class="comment">         * block-data form and either the externalizable class doesn't exist</span></span><br><span class="line"><span class="comment">         * locally (i.e., obj == null) or readExternal() just threw a</span></span><br><span class="line"><span class="comment">         * CNFException, then the stream is probably in an inconsistent state,</span></span><br><span class="line"><span class="comment">         * since some (or all) of the externalizable data may not have been</span></span><br><span class="line"><span class="comment">         * consumed.  Since there's no "correct" action to take in this case,</span></span><br><span class="line"><span class="comment">         * we mimic the behavior of past serialization implementations and</span></span><br><span class="line"><span class="comment">         * blindly hope that the stream is in sync; if it isn't and additional</span></span><br><span class="line"><span class="comment">         * externalizable data remains in the stream, a subsequent read will</span></span><br><span class="line"><span class="comment">         * most likely throw a StreamCorruptedException.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;如果obj非空，那么尝试通过readExternal()方法读取externalizable数据。</p>
<h4 id="private-void-readSerialData-Object-obj-ObjectStreamClass-desc"><a href="#private-void-readSerialData-Object-obj-ObjectStreamClass-desc" class="headerlink" title="private void readSerialData(Object obj, ObjectStreamClass desc)"></a>private void readSerialData(Object obj, ObjectStreamClass desc)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSerialData</span><span class="params">(Object obj, ObjectStreamClass desc)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ObjectStreamClass.ClassDataSlot[] slots = desc.getClassDataLayout();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; slots.length; i++) &#123;</span><br><span class="line">        ObjectStreamClass slotDesc = slots[i].desc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slots[i].hasData) &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                slotDesc.hasReadObjectMethod() &amp;&amp;</span><br><span class="line">                handles.lookupException(passHandle) == <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                SerialCallbackContext oldContext = curContext;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    curContext = <span class="keyword">new</span> SerialCallbackContext(obj, slotDesc);</span><br><span class="line"></span><br><span class="line">                    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">                    slotDesc.invokeReadObject(obj, <span class="keyword">this</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * In most cases, the handle table has already</span></span><br><span class="line"><span class="comment">                         * propagated a CNFException to passHandle at this</span></span><br><span class="line"><span class="comment">                         * point; this mark call is included to address cases</span></span><br><span class="line"><span class="comment">                         * where the custom readObject method has cons'ed and</span></span><br><span class="line"><span class="comment">                         * thrown a new CNFException of its own.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                    handles.markException(passHandle, ex);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    curContext.setUsed();</span><br><span class="line">                    curContext = oldContext;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * defaultDataEnd may have been set indirectly by custom</span></span><br><span class="line"><span class="comment">                     * readObject() method when calling defaultReadObject() or</span></span><br><span class="line"><span class="comment">                     * readFields(); clear it to restore normal read behavior.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                defaultDataEnd = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                defaultReadFields(obj, slotDesc);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (slotDesc.hasWriteObjectData()) &#123;</span><br><span class="line">                skipCustomData();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                slotDesc.hasReadObjectNoDataMethod() &amp;&amp;</span><br><span class="line">                handles.lookupException(passHandle) == <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                slotDesc.invokeReadObjectNoData(obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从流中读取每个实现了serializable接口的对象的实例化数据（从父类到子类全部）。第3行代码返回了类描述符desc指定的序列化的对象的数据层次（从父类开始）。遍历这些数据层次对象，如果obj有效，且数据层次有方法<strong>readObject</strong>且当前不存在异常，那么第18行代码就通过调用类的readObject方法来完成反序列化操作。如果数据层次无数据，那么第49行代码就通过调用类的readObjectNoData方法来完成反序列化操作。</p>
<h4 id="public-Object-readUnshared"><a href="#public-Object-readUnshared" class="headerlink" title="public Object readUnshared()"></a>public Object readUnshared()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">readUnshared</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// if nested read, passHandle contains handle of enclosing object</span></span><br><span class="line">    <span class="keyword">int</span> outerHandle = passHandle;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object obj = readObject0(<span class="keyword">true</span>);</span><br><span class="line">        handles.markDependency(outerHandle, passHandle);</span><br><span class="line">        ClassNotFoundException ex = handles.lookupException(passHandle);</span><br><span class="line">        <span class="keyword">if</span> (ex != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">            vlist.doCallbacks();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        passHandle = outerHandle;</span><br><span class="line">        <span class="keyword">if</span> (closed &amp;&amp; depth == <span class="number">0</span>) &#123;</span><br><span class="line">            clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从ObjectInputStream中读取含有私有类或者包内私有类的对象。这个方法被用在“保护不共享的反序列对象”场景中。如果一个类含有私有类的，或者包内私有类的对象引用字段，并且这些私有类或者包内私有类在当前类外（包外）不可用，那么这些引用对象需要作为反序列化过程的一部分来执行保护性复制（defensively copied）。或者通过调用ObjectOutputStream.writeUnshared 和ObjectInputStream.readUnshared保证内部对象的唯一引用。</p>
<p>&emsp;&emsp;在复制策略中，从流中反序列化得到的子类被认为是不信任的输入 — 新创建的、反序列化之后拥有相同值的子对象应该被根据readObject方法得到的子对象替换掉。这么做是为了适应如下场景：一个不可变的对象包含了一个可变的内部私有的子类引用。如果在反序列一个容器对象的过程中没有特殊的处理来应对子类复制，那么可能在通过向序列化流写入数据过程中夹杂着可能会违反容器类的不可变性的恶意执行。</p>
<h4 id="public-void-defaultReadObject"><a href="#public-void-defaultReadObject" class="headerlink" title="public void defaultReadObject()"></a>public void defaultReadObject()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defaultReadObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    SerialCallbackContext ctx = curContext;</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotActiveException(<span class="string">"not in call to readObject"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Object curObj = ctx.getObj();</span><br><span class="line">    ObjectStreamClass curDesc = ctx.getDesc();</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">    defaultReadFields(curObj, curDesc);</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (!curDesc.hasWriteObjectData()) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Fix for 4360508: since stream does not contain terminating</span></span><br><span class="line"><span class="comment">             * TC_ENDBLOCKDATA tag, set flag so that reading code elsewhere</span></span><br><span class="line"><span class="comment">             * knows to simulate end-of-custom-data behavior.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        defaultDataEnd = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ClassNotFoundException ex = handles.lookupException(passHandle);</span><br><span class="line">    <span class="keyword">if</span> (ex != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从流中读取非static、transient关键字修饰的内容。ObjectInputStream自身没有调用该方法，该方法被需要反序列化的类的readObject方法调用。通过<strong>defaultReadFields(Object obj, ObjectStreamClass desc)</strong>方法完成反序列内容的读取。</p>
<h4 id="private-void-defaultReadFields-Object-obj-ObjectStreamClass-desc"><a href="#private-void-defaultReadFields-Object-obj-ObjectStreamClass-desc" class="headerlink" title="private void defaultReadFields(Object obj, ObjectStreamClass desc)"></a>private void defaultReadFields(Object obj, ObjectStreamClass desc)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defaultReadFields</span><span class="params">(Object obj, ObjectStreamClass desc)</span> </span></span><br><span class="line"><span class="function">    	<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Class cl = desc.forClass();</span><br><span class="line">    <span class="keyword">if</span> (cl != <span class="keyword">null</span> &amp;&amp; obj != <span class="keyword">null</span> &amp;&amp; !cl.isInstance(obj)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> primDataSize = desc.getPrimDataSize();</span><br><span class="line">    <span class="keyword">if</span> (primVals == <span class="keyword">null</span> || primVals.length &lt; primDataSize) &#123;</span><br><span class="line">        primVals = <span class="keyword">new</span> <span class="keyword">byte</span>[primDataSize];</span><br><span class="line">    &#125;</span><br><span class="line">    bin.readFully(primVals, <span class="number">0</span>, primDataSize, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        desc.setPrimFieldValues(obj, primVals);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> objHandle = passHandle;</span><br><span class="line">    ObjectStreamField[] fields = desc.getFields(<span class="keyword">false</span>);</span><br><span class="line">    Object[] objVals = <span class="keyword">new</span> Object[desc.getNumObjFields()];</span><br><span class="line">    <span class="keyword">int</span> numPrimFields = fields.length - objVals.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objVals.length; i++) &#123;</span><br><span class="line">        ObjectStreamField f = fields[numPrimFields + i];</span><br><span class="line">        objVals[i] = readObject0(f.isUnshared());</span><br><span class="line">        <span class="keyword">if</span> (f.getField() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handles.markDependency(objHandle, passHandle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        desc.setObjFieldValues(obj, objVals);</span><br><span class="line">    &#125;</span><br><span class="line">    passHandle = objHandle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;根据指定类描述符读取被序列化了的字段的内容。第3 ~ 6行代码得到需要反序列的对象的类信息。第8 ~ 15行代码得到对象中基础数据类型字段的数量和字段存储的具体值内容。第18行代码得到对象的所有字段，第19行代码得到对象的非基础数据类型的字段变量内容。第20 ~ 27行代码取得所有非基础数据类型字段存储的值内容。第28 ~ 30行代码完成字段赋值操作。最后更新passHandle。</p>
<h4 id="public-ObjectInputStream-GetField-readFields"><a href="#public-ObjectInputStream-GetField-readFields" class="headerlink" title="public ObjectInputStream.GetField readFields()"></a>public ObjectInputStream.GetField readFields()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ObjectInputStream.<span class="function">GetField <span class="title">readFields</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    SerialCallbackContext ctx = curContext;</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotActiveException(<span class="string">"not in call to readObject"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Object curObj = ctx.getObj();</span><br><span class="line">    ObjectStreamClass curDesc = ctx.getDesc();</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">    GetFieldImpl getField = <span class="keyword">new</span> GetFieldImpl(curDesc);</span><br><span class="line">    getField.readFields();</span><br><span class="line">    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (!curDesc.hasWriteObjectData()) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Fix for 4360508: since stream does not contain terminating</span></span><br><span class="line"><span class="comment">             * TC_ENDBLOCKDATA tag, set flag so that reading code elsewhere</span></span><br><span class="line"><span class="comment">             * knows to simulate end-of-custom-data behavior.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        defaultDataEnd = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getField;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从流中读取字段变量值（基础数据类型和对象类型），并返回一个GetField实例。</p>
<h4 id="public-void-registerValidation-ObjectInputValidation-obj-int-prio"><a href="#public-void-registerValidation-ObjectInputValidation-obj-int-prio" class="headerlink" title="public void registerValidation(ObjectInputValidation obj, int prio)"></a>public void registerValidation(ObjectInputValidation obj, int prio)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerValidation</span><span class="params">(ObjectInputValidation obj, <span class="keyword">int</span> prio)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NotActiveException, InvalidObjectException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotActiveException(<span class="string">"stream inactive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    vlist.register(obj, prio);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="protected-boolean-enableResolveObject-boolean-enable"><a href="#protected-boolean-enableResolveObject-boolean-enable" class="headerlink" title="protected boolean enableResolveObject(boolean enable)"></a>protected boolean enableResolveObject(boolean enable)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">enableResolveObject</span><span class="params">(<span class="keyword">boolean</span> enable)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SecurityException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (enable == enableResolve) &#123;</span><br><span class="line">        <span class="keyword">return</span> enable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sm.checkPermission(SUBSTITUTION_PERMISSION);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enableResolve = enable;</span><br><span class="line">    <span class="keyword">return</span> !enableResolve;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="public-int-read"><a href="#public-int-read" class="headerlink" title="public int read()"></a>public int read()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bin.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="String-readTypeString"><a href="#String-readTypeString" class="headerlink" title="String readTypeString()"></a>String readTypeString()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">readTypeString</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oldHandle = passHandle;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">byte</span> tc = bin.peekByte();</span><br><span class="line">        <span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">            <span class="keyword">case</span> TC_NULL:</span><br><span class="line">                <span class="keyword">return</span> (String) readNull();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_REFERENCE:</span><br><span class="line">                <span class="keyword">return</span> (String) readHandle(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_STRING:</span><br><span class="line">            <span class="keyword">case</span> TC_LONGSTRING:</span><br><span class="line">                <span class="keyword">return</span> readString(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                    String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        passHandle = oldHandle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;读取一个字符串且不允许被替换。在ObjectStreamClass.read()方法中被调用。</p>
<h4 id="private-boolean-isCustomSubclass"><a href="#private-boolean-isCustomSubclass" class="headerlink" title="private boolean isCustomSubclass()"></a>private boolean isCustomSubclass()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCustomSubclass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Return true if this class is a custom subclass of ObjectInputStream</span></span><br><span class="line">    <span class="keyword">return</span> getClass().getClassLoader() != ObjectInputStream.class.getClassLoader();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;如果当前类是ObjectInputStream的一个定制子类实现，那么返回true。</p>
<h4 id="private-static-native-void-bytesToFloats-byte-src-int-srcpos-float-dst-int-dstpos-int-nfloats"><a href="#private-static-native-void-bytesToFloats-byte-src-int-srcpos-float-dst-int-dstpos-int-nfloats" class="headerlink" title="private static native void bytesToFloats(byte[] src, int srcpos, float[] dst, int dstpos, int nfloats);"></a>private static native void bytesToFloats(byte[] src, int srcpos, float[] dst, int dstpos, int nfloats);</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">bytesToFloats</span><span class="params">(<span class="keyword">byte</span>[] src, <span class="keyword">int</span> srcpos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">float</span>[] dst, <span class="keyword">int</span> dstpos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">int</span> nfloats)</span></span>;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;完成byte向float的转换。native方法，由系统提供并完成处理。</p>
<h4 id="private-static-native-void-bytesToDoubles-byte-src-int-srcpos-double-dst-int-dstpos-int-ndoubles"><a href="#private-static-native-void-bytesToDoubles-byte-src-int-srcpos-double-dst-int-dstpos-int-ndoubles" class="headerlink" title="private static native void bytesToDoubles(byte[] src, int srcpos, double[] dst, int dstpos, int ndoubles);"></a>private static native void bytesToDoubles(byte[] src, int srcpos, double[] dst, int dstpos, int ndoubles);</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">bytesToDoubles</span><span class="params">(<span class="keyword">byte</span>[] src, <span class="keyword">int</span> srcpos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">double</span>[] dst, <span class="keyword">int</span> dstpos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">int</span> ndoubles)</span></span>;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;完成byte向double的转换。native方法，由系统提供并完成处理。</p>
<p>&emsp;</p>
<h2 id="涉及基础知识点"><a href="#涉及基础知识点" class="headerlink" title="涉及基础知识点"></a>涉及基础知识点</h2><ol>
<li><strong>Graphs of objects are restored correctly using a reference sharing mechanism.  </strong></li>
</ol>
<p>&emsp;</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a href="https://blog.csdn.net/kagoy/article/details/12000253" target="_blank" rel="noopener">https://blog.csdn.net/kagoy/article/details/12000253</a></li>
<li><a href="https://blog.csdn.net/abc123lzf/article/details/82318148" target="_blank" rel="noopener">https://blog.csdn.net/abc123lzf/article/details/82318148</a></li>
<li><a href="https://www.hollischuang.com/archives/1140" target="_blank" rel="noopener">https://www.hollischuang.com/archives/1140</a></li>
<li><a href="https://yq.aliyun.com/articles/646150" target="_blank" rel="noopener">https://yq.aliyun.com/articles/646150</a></li>
<li><a href="http://www.voidcn.com/article/p-xjvhzlxn-nx.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-xjvhzlxn-nx.html</a></li>
<li><a href="https://blog.csdn.net/abc123lzf/article/details/82318148" target="_blank" rel="noopener">https://blog.csdn.net/abc123lzf/article/details/82318148</a></li>
<li><a href="http://www.bubuko.com/infodetail-2129058.html" target="_blank" rel="noopener">http://www.bubuko.com/infodetail-2129058.html</a></li>
<li><a href="https://blog.csdn.net/shenchaohao12321/article/details/79521774" target="_blank" rel="noopener">https://blog.csdn.net/shenchaohao12321/article/details/79521774</a></li>
<li><a href="https://286.iteye.com/blog/2227942" target="_blank" rel="noopener">https://286.iteye.com/blog/2227942</a></li>
<li><a href="https://286.iteye.com/blog/2227950" target="_blank" rel="noopener">https://286.iteye.com/blog/2227950</a></li>
<li><a href="https://xz.aliyun.com/t/2223" target="_blank" rel="noopener">https://xz.aliyun.com/t/2223</a></li>
<li><a href="http://www.importnew.com/24490.html" target="_blank" rel="noopener">http://www.importnew.com/24490.html</a></li>
<li><a href="http://www.importnew.com/20125.html" target="_blank" rel="noopener">http://www.importnew.com/20125.html</a></li>
<li><a href="http://www.importnew.com/17964.html" target="_blank" rel="noopener">http://www.importnew.com/17964.html</a></li>
<li><a href="http://www.importnew.com/18024.html" target="_blank" rel="noopener">http://www.importnew.com/18024.html</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-serial/" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-lo-serial/</a></li>
<li>Java Object Serialization Specification 1.6</li>
</ol>
<p>&emsp;<br>&emsp;<br>&emsp;<br>&emsp;</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
  	</section>
  	
	  	<div>
		  	
				<div>
	<div style="text-align:center;color: #ccc;font-size:20px;">------------- End of this article, thanks! -------------
	<br>&emsp;</div>
</div>
		  	
		</div>
	    
		 	
		      	<section class="post-declare">
<p>
<div style="background-color:#E8E8E8;color:#000;padding:10px 15px 15px 20px;"><br><b>&emsp;&emsp;版权声明</b>：本文由<b><a href="/about" target="_blank" title="Nathan R. Lee">Nathan R. Lee</a></b>创作和发表，采用<b>署名(BY)</b>-<b>非商业性使用(NC)</b>-<b>相同方式共享(SA)</b>国际许可协议进行许可，转载请注明作者及出处。<br>&emsp;&emsp;本文作者为&nbsp;<b><a href="/about" target="_blank" title="Nathan R. Lee">Nathan R. Lee</a></b><br>&emsp;&emsp;本文标题为&nbsp;<b><a href="/2018/java-ObjectInputStream.html" target="_blank" title="Java I/O 23 - ObjectInputStream">Java I/O 23 - ObjectInputStream</a></b><br>&emsp;&emsp;本文链接为&nbsp;<b><a href="/2018/java-ObjectInputStream.html" target="_blank" title="Java I/O 23 - ObjectInputStream">https://marcuseddie.github.io/2018/java-ObjectInputStream.html</a></b></div>
</p>
<section class="post-declare">
		  	
	  	
	  	
	  	<section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>
	
	
<div class="prev_next clearfix">
	<div style="width:50%;float:left;">
		
			
				<a href="/2018/java-ObjectInputStream-InternalClass.html" class="alignleft prev" title="Java I/O 24 - ObjectInputStream内部类"> 上一篇： Java I/O 24 - ObjectInputStream内部类</a>
			
		
	</div>
	<div style="width:50%;float:right;">
		
			
				<a href="/2018/java-Collection-Stack.html" class="alignright next" title="Java Collection 05 - Stack"> 下一篇： Java Collection 05 - Stack</a>
			
		
	</div>
</div>

	<script>
	    function createImgEventFullScreen() {
	        var imgs = $(".post").find("img");
	        for (var i = 0; i < imgs.length; i++) {
	            imgs[i].onclick = function (e) {
	                var ent = e.srcElement ? e.srcElement : e.target; // 兼容ie、Firefox、Chrome等
	                var src = ent.currentSrc;
	                var _this = $(this);
	                createCover(src,_this);
	            }
	        }
	        function createCover(src,_this) {
	            var cover = $("<div id='outerDiv' style='position:fixed;top:0;left:0;background:rgba(0,0,0,0.9);z-index:900;width:100%;height:100%;display:none;'><div id='innerDiv' style='position:absolute;'><img  id='bigImg' style='border:5px solid #fff;' src=''/></div></div>");
	            $("#outerDiv").remove();
	            $("body").append(cover);
	            imgShow("#outerDiv", "#innerDiv", "#bigImg", _this,src);
	        }
	    }

	    function imgShow(outerDiv, innerDiv, bigImg, _this,src) {
	        $(bigImg).attr("src", src); //设置#bigImg元素的src属性
	        /*获取当前点击图片的真实大小，并显示弹出层及大图*/
	        $("<img/>").attr("src", src).load(function () {
	            var windowW = $(window).width(); //获取当前窗口宽度
	            var windowH = $(window).height(); //获取当前窗口高度
	            var realWidth = this.width; //获取图片真实宽度
	            var realHeight = this.height; //获取图片真实高度
	            var imgWidth, imgHeight;
	            var scale = 0.8; //缩放尺寸，当图片真实宽度和高度大于窗口宽度和高度时进行缩放

	            if (realHeight > windowH * scale) { //判断图片高度
	                imgHeight = windowH * scale; //如大于窗口高度，图片高度进行缩放
	                imgWidth = imgHeight / realHeight * realWidth; //等比例缩放宽度
	                if (imgWidth > windowW * scale) { //如宽度仍大于窗口宽度
	                    imgWidth = windowW * scale; //再对宽度进行缩放
	                }
	            } else if (realWidth > windowW * scale) { //如图片高度合适，判断图片宽度
	                imgWidth = windowW * scale; //如大于窗口宽度，图片宽度进行缩放
	                imgHeight = imgWidth / realWidth * realHeight; //等比例缩放高度
	            } else { //如果图片真实高度和宽度都符合要求，高宽不变
	                imgWidth = realWidth;
	                imgHeight = realHeight;
	            }
	            $(bigImg).css("width", imgWidth); //以最终的宽度对图片缩放

	            var w = (windowW - imgWidth) / 2; //计算图片与窗口左边距
	            var h = (windowH - imgHeight) / 2; //计算图片与窗口上边距
	            $(innerDiv).css({ "top": h, "left": w }); //设置#innerDiv的top和left属性
	            $(outerDiv).fadeIn("fast"); //淡入显示#outerDiv
	        });

	        $(outerDiv).click(function () { //再次点击淡出消失弹出层
	            $(this).fadeOut("fast");
	        });
	    }
	    setTimeout(function () {
	        createImgEventFullScreen();
	    }, 1000)
	</script>
</section></section></article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2018-2020. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 </span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>

    
    <script src="/js/d3@6"></script>
    <!--
      <script src="/js/markmap-view@0.2.7"></script>
    -->
    

      <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
		  
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
		  
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
		isfetched = false;
        $('.popup').hide();
		$(".popoverlay").remove();
		$('body').css('overflow', '');
      };
    });

    $('.popup-btn-close').click(function(e){
	  isfetched = false;
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


    

    <script type="text/javascript" src="/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/jquery.min.js"></script>
    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
